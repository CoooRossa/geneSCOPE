% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/10.LvsRcurve.r
\name{getTopDeltaL}
\alias{getTopDeltaL}
\title{Retrieve top gene pairs by Delta (Lee's L - Pearson r) with simplified permutation test}
\usage{
getTopDeltaL(
  coordObj,
  grid_name,
  pear_level = c("cell", "grid"),
  pear_range = c(-1, 1),
  L_range = c(-1, 1),
  top_n = 10,
  direction = c("largest", "smallest", "both"),
  do_perm = TRUE,
  perms = 1000,
  block_side = 8,
  use_blocks = TRUE,
  ncores = 1,
  clamp_mode = c("none", "ref_only", "both"),
  p_adj_mode = c("BH", "BY", "BH_universe", "BY_universe", "bonferroni"),
  mem_limit_GB = 2,
  pval_mode = c("beta", "mid", "uniform")
)
}
\arguments{
\item{clamp_mode}{Character: c("none","ref_only","both") defines Delta statistic:
\describe{
\item{none}{Delta = L - r (original, retains positive and negative correlation information)}
\item{ref_only}{Reference value uses r* = max(r,0), permutation retains original r → p-values conservative}
\item{both}{Current implementation still equivalent to ref_only (reference truncation only), marked as Delta_clamp_Ronly}
}}

\item{p_adj_mode}{Multiple correction mode (see below).}

\item{pval_mode}{Character: c("beta","mid","uniform"):
\describe{
\item{beta}{(k+1)/(N+2) Jeffreys smoothing (default)}
\item{mid}{(k+0.5)/(N+1) mid-p, slightly less conservative but still discrete}
\item{uniform}{(k+U)/(N+1) random jitter to alleviate ties (expectation unchanged)}
}}
}
\value{
data.frame containing gene1,gene2,LeesL,Pear,Delta,raw_p,FDR,stat_type,pval_mode
}
\description{
Only perform fixed number of permutations on selected top gene pairs; supports optional non-negative truncation of Pearson r to form different definitions of Delta statistic.
}
\details{
Compared to Seurat::FindMarkers p-values "appear more continuous" due to:
\itemize{
\item FindMarkers typically uses parametric/asymptotic tests (e.g., wilcox/t/MAST/DESeq2/LR), directly computing p-values from analytical distributions → theoretically continuous (floating-point display can have multiple decimal places).
\item This function uses a finite number of permutations (perms), p-value resolution is limited by the grid of 1/(perms+1); even with beta / mid
formulas only providing smooth correction, it remains discrete; the uniform scheme adds random noise to break ties, but the expectation remains
equal to the original discrete grid.
\item To achieve a more continuous appearance similar to FindMarkers, you can:
\enumerate{
\item Increase perms (reduce step size);
\item Choose pval_mode='uniform' to randomize levels;
\item Or add an analytical test mode (not yet implemented), for example, establish a joint null model of Lee's L and r, then
use approximate normal/asymptotic distribution to infer Delta (requires additional theoretical support).
}
\item Discrete p-values are not inherently wrong, often statistically more conservative.
}

(Supplement) Effect of permutation count on "significance threshold":
Actual α threshold remains unchanged; increasing perms only reduces Monte Carlo sampling error and refines p-value step size (≈1/(N+1)).
Output column mc_se≈sqrt(p*(1-p)/N), and Clopper–Pearson interval
can be used to assess whether more perms are needed.
}
\section{Definition of Universe}{

universe = total_universe = all candidate gene pairs after filtering by pear_range and L_range (nrow(df)).
The top set is just the extreme pairs selected from the universe. In *_universe mode, although only the top is permuted,
multiple correction uses the universe as the total number of hypothesis tests (more conservative).
}

