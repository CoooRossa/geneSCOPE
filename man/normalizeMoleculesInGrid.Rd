% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/2.Normalization.r
\name{normalizeMoleculesInGrid}
\alias{normalizeMoleculesInGrid}
\title{normalizeMoleculesInGrid - Row normalization + Column Z-score (legacy numeric compatibility, memory-efficient compromise)}
\usage{
normalizeMoleculesInGrid(
  scope_obj,
  grid_name = NULL,
  keep_zero_grids = FALSE,
  row_norm = TRUE,
  zero_var_to_zero = TRUE,
  var_eps = 0,
  mem_dense_limit = 2e+11,
  verbose = TRUE
)
}
\arguments{
\item{scope_obj}{A \code{scope_object} that already contains a grid layer.}

\item{grid_name}{Target grid sub-layer; if \code{NULL} the sole sub-layer is used automatically.}

\item{keep_zero_grids}{Logical. Whether to keep grids whose counts are all zero.}

\item{row_norm}{Logical. If \code{TRUE} (default) perform row normalization first.}

\item{zero_var_to_zero}{Logical. If \code{TRUE} (default) set columns with variance ≤ \code{var_eps} to zero.}

\item{var_eps}{Numeric. Threshold below which variance is considered "near zero."}

\item{mem_dense_limit}{Numeric. Threshold for \code{nrow * ncol}; if the product exceeds this value the sparse matrix is coerced to dense anyway (default \code{2e11}, roughly 16 GB of RAM for a \code{double} matrix).}

\item{verbose}{Logical. Whether to print progress messages (default TRUE).}
}
\value{
The modified \code{scope_object} containing a new \code{$Xz} slot.
}
\description{
Generates a "grid × gene" matrix → row normalization → \strong{dense conversion}; reproduces legacy results exactly using \code{base::scale()} with sample SD. If the matrix element count exceeds \code{mem_dense_limit} it is still coerced to dense (with a warning).
}
\details{
The function materializes a sparse \code{dgCMatrix} of grid-level transcript
counts, optionally normalizes each row to library size, and then performs a
column-wise standardization identical to \code{base::scale()} with sample
standard deviation (\eqn{n-1}). Conversion to a dense matrix (\code{Xd}) is
required to replicate legacy results; \code{mem_dense_limit} protects against
inadvertently allocating very large dense matrices.

Zero-variance columns are optionally replaced by zeros because
\code{scale()} returns \code{NA} for such columns in R < 4.4 and drops
the \code{scaled:scale} attribute from R 4.4 onwards. Setting
\code{var_eps} to a positive tolerance can aggressively zero
near-constant genes, reducing downstream file sizes.
}
\examples{
\dontrun{
## Compute Z-score expression for 25 µm grid, retaining empty grids
P5.coord <- normalizeMoleculesInGrid(
  P5.coord,
  grid_name       = "25um",
  keep_zero_grids = TRUE,
  mem_dense_limit = 5e8 # 500 M elements ~ 4 GB RAM
)
}
}

