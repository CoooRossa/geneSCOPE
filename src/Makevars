# Cross-platform Makevars for geneSCOPE package
# Optimized for GitHub distribution and devtools::install_github()

CXX_STD = CXX17

# Enable 64-bit indexing for large matrices
PKG_CPPFLAGS = -DARMA_64BIT_WORD=1 -DARMA_NO_DEBUG=1

# Prevent BLAS threading conflicts
PKG_CPPFLAGS += -DOPENBLAS_NUM_THREADS=1 -DMKL_NUM_THREADS=1

# Platform detection
UNAME_S := $(shell uname -s)

# Cross-platform optimization
ifeq ($(UNAME_S),Darwin)
    # === macOS Configuration ===
    # Try to detect and use libomp if available
    HOMEBREW_PREFIX := $(shell brew --prefix 2>/dev/null || echo /usr/local)
    LIBOMP_PREFIX := $(shell find $(HOMEBREW_PREFIX) -name "libomp" -type d 2>/dev/null | head -1)
    
    ifneq ($(LIBOMP_PREFIX),)
        # OpenMP available via Homebrew
        PKG_CXXFLAGS = -Xclang -fopenmp -I$(LIBOMP_PREFIX)/include
        PKG_LIBS = -L$(LIBOMP_PREFIX)/lib -lomp
    else
        # No OpenMP - use conservative settings
        PKG_CPPFLAGS += -DARMA_DONT_USE_OPENMP
        PKG_CXXFLAGS = -O2
    endif
    
    # Additional macOS optimizations
    PKG_CXXFLAGS += -g0 -ffast-math
    
else
    # === Linux Configuration ===
    # Try GCC OpenMP first
    HAS_GOMP := $(shell echo | gcc -fopenmp -E - >/dev/null 2>&1 && echo yes || echo no)
    
    ifeq ($(HAS_GOMP),yes)
        PKG_CXXFLAGS = -fopenmp -O2 -march=native -mtune=native
        PKG_LIBS = -fopenmp
    else
        # Fallback without OpenMP
        PKG_CPPFLAGS += -DARMA_DONT_USE_OPENMP
        PKG_CXXFLAGS = -O2 -march=native
    endif
endif

# Memory and computation optimizations
PKG_CPPFLAGS += -DARMA_USE_LAPACK -DARMA_USE_BLAS

# Disable debug for release builds
PKG_CPPFLAGS += -DNDEBUG

# Additional compiler optimizations
PKG_CXXFLAGS += -fno-strict-aliasing